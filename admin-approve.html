<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon Links -->
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
    <title>Review Management - Salve Regina School</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .admin-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        }
        .admin-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .success-icon {
            animation: checkmark 0.6s ease-in-out;
        }
        .error-icon {
            animation: shake 0.6s ease-in-out;
        }
        @keyframes checkmark {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .review-preview {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        .btn-home {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            transition: all 0.3s ease;
        }
        .btn-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="admin-container flex items-center justify-center p-4">
    <div class="container max-w-2xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Review Management</h1>
            <p class="text-xl text-white opacity-90">Salve Regina School Admin Panel</p>
        </div>

        <!-- Admin Card -->
        <div class="admin-card p-8 rounded-2xl shadow-2xl">
            <!-- Loading State -->
            <div id="loadingState" class="text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
                <p class="text-lg text-gray-600">Processing review action...</p>
            </div>

            <!-- Success State -->
            <div id="successState" class="text-center hidden">
                <div class="success-icon mb-6">
                    <svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Action Completed Successfully!</h2>
                <div class="status-badge status-approved mb-4" id="actionBadge"></div>
                <div class="review-preview" id="reviewPreview"></div>
                <p class="text-gray-600 mb-6">The review has been processed and the website has been updated automatically.</p>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-green-800">
                        ✅ <strong>Next Steps:</strong><br>
                        • Visit the main website to see the updated reviews<br>
                        • The review carousel will show the new content<br>
                        • Changes are automatically saved in the browser
                    </p>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="text-center hidden">
                <div class="error-icon mb-6">
                    <svg class="w-16 h-16 mx-auto text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Action Failed</h2>
                <p class="text-red-600 mb-4" id="errorMessage">Unable to process the review action.</p>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-red-800">
                        <strong>Possible reasons:</strong><br>
                        • Review ID not found in pending reviews<br>
                        • Review was already processed<br>
                        • Invalid or expired approval link<br>
                        • Browser storage issues or disabled localStorage
                    </p>
                </div>
            </div>

            <!-- Admin Dashboard Link -->
            <div id="adminActions" class="text-center mt-8 hidden">
                <button onclick="showAdminDashboard()" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-6 rounded-lg mr-4">
                    📊 View All Reviews
                </button>
                <button onclick="exportReviews()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">
                    💾 Export Data
                </button>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="hidden mt-8">
                <h3 class="text-2xl font-bold mb-4">📋 Review Dashboard</h3>
                <div id="reviewStats" class="grid grid-cols-3 gap-4 mb-6"></div>
                <div id="reviewsList"></div>
            </div>

            <!-- Back to Website -->
            <div class="text-center mt-8">
                <a href="index.html" class="btn-home inline-flex items-center text-white font-semibold py-3 px-6 rounded-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to School Website
                </a>
            </div>
        </div>
    </div>

    <!-- Include review management system -->
    <script src="reviews.js"></script>
    
    <script>
        // URL parameter processing
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Process review action from URL parameters
        function processReviewAction() {
            const action = getUrlParameter('action'); // 'approve' or 'reject'
            const reviewId = getUrlParameter('id');
            const token = getUrlParameter('token'); // Simple security token

            console.log('Processing action:', action, 'for review:', reviewId);

            // Show loading state
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('successState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');

            // Validate parameters
            if (!action || !reviewId) {
                showError('Invalid approval link. Missing action or review ID parameters.');
                return;
            }

            if (action !== 'approve' && action !== 'reject') {
                showError('Invalid action specified. Only "approve" or "reject" actions are allowed.');
                return;
            }

            // Simple token validation
            const expectedToken = btoa(reviewId + action).substring(0, 8);
            if (token !== expectedToken) {
                showError('Invalid or expired approval link. Please use the latest email notification.');
                return;
            }

            // Wait for ReviewManager to be ready
            setTimeout(() => {
                try {
                    let result = false;
                    let reviewData = null;

                    // Check if ReviewManager is available
                    if (!window.ReviewManager) {
                        showError('Review management system not loaded. Please refresh the page and try again.');
                        return;
                    }

                    // Get review data before processing
                    const pendingReviews = window.ReviewManager.getPendingReviews();
                    reviewData = pendingReviews.find(review => review.id === reviewId);

                    if (!reviewData) {
                        // Check if already in approved reviews
                        const approvedReviews = window.ReviewManager.getApprovedReviews();
                        reviewData = approvedReviews.find(review => review.id === reviewId);
                        if (reviewData) {
                            showError('This review has already been approved and is visible on the website.');
                            return;
                        } else {
                            showError('Review not found. It may have already been processed, deleted, or the link may be invalid.');
                            return;
                        }
                    }

                    // Process the action
                    if (action === 'approve') {
                        result = window.ReviewManager.approveReview(reviewId);
                        console.log('Approval result:', result);
                    } else {
                        result = window.ReviewManager.rejectReview(reviewId);
                        console.log('Rejection result:', result);
                    }

                    if (result) {
                        showSuccess(action, reviewData);
                    } else {
                        showError(`Failed to ${action} review. The review may have already been processed or there was a technical error.`);
                    }
                } catch (error) {
                    console.error('Error processing review action:', error);
                    showError('An unexpected error occurred while processing the review. Check browser console for details.');
                }
            }, 1500); // Give time for ReviewManager to initialize
        }

        function showSuccess(action, reviewData) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('successState').classList.remove('hidden');
            document.getElementById('adminActions').classList.remove('hidden');

            // Update action badge
            const badge = document.getElementById('actionBadge');
            const badgeText = action === 'approve' ? 'Review Approved ✅' : 'Review Rejected ❌';
            badge.textContent = badgeText;
            badge.className = `status-badge ${action === 'approve' ? 'status-approved' : 'status-rejected'}`;

            // Show review preview
            const preview = document.getElementById('reviewPreview');
            preview.innerHTML = `
                <div class="text-left">
                    <p><strong>👤 Reviewer:</strong> ${reviewData.fullName}</p>
                    <p><strong>📧 Email:</strong> ${reviewData.email}</p>
                    <p><strong>🏫 Relationship:</strong> ${reviewData.relationship}</p>
                    <p><strong>📝 Review:</strong> "${reviewData.review.length > 200 ? reviewData.review.substring(0, 200) + '...' : reviewData.review}"</p>
                    <p><strong>📅 Submitted:</strong> ${new Date(reviewData.timestamp).toLocaleDateString()}</p>
                    <p><strong>⚡ Processed:</strong> ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                </div>
            `;

            // Update page title
            document.title = `Review ${action === 'approve' ? 'Approved' : 'Rejected'} - Salve Regina School`;
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('successState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('adminActions').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
            
            // Update page title
            document.title = 'Review Processing Error - Salve Regina School';
        }

        function showAdminDashboard() {
            const dashboard = document.getElementById('adminDashboard');
            dashboard.classList.toggle('hidden');

            if (!dashboard.classList.contains('hidden')) {
                updateAdminDashboard();
            }
        }

        function updateAdminDashboard() {
            if (!window.ReviewManager) {
                document.getElementById('reviewsList').innerHTML = '<p class="text-red-500">Review management system not available.</p>';
                return;
            }

            const stats = window.ReviewManager.getStats();
            
            // Update statistics
            const statsDiv = document.getElementById('reviewStats');
            statsDiv.innerHTML = `
                <div class="bg-yellow-100 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-yellow-800">${stats.pendingCount}</div>
                    <div class="text-sm text-yellow-600">⏳ Pending</div>
                </div>
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-800">${stats.approvedCount}</div>
                    <div class="text-sm text-green-600">✅ Approved</div>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-800">${stats.totalCount}</div>
                    <div class="text-sm text-blue-600">📊 Total</div>
                </div>
            `;

            // Update reviews list
            const reviewsList = document.getElementById('reviewsList');
            let html = '<div class="space-y-4">';
            
            // Show pending reviews
            if (stats.pendingReviews.length > 0) {
                html += '<h4 class="font-semibold text-yellow-600 text-lg">⏳ Pending Reviews:</h4>';
                stats.pendingReviews.forEach(review => {
                    html += `
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-semibold text-lg">${review.fullName}</p>
                                    <p class="text-sm text-gray-600 mb-2">${review.relationship}</p>
                                    <p class="text-sm bg-white p-2 rounded border-l-2 border-yellow-400">"${review.review.substring(0, 120)}${review.review.length > 120 ? '...' : ''}"</p>
                                    <p class="text-xs text-gray-500 mt-2">📅 Submitted: ${new Date(review.timestamp).toLocaleDateString()}</p>
                                </div>
                                <div class="flex flex-col space-y-2 ml-4">
                                    <button onclick="adminApproveReview('${review.id}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-semibold">
                                        ✅ Approve
                                    </button>
                                    <button onclick="adminRejectReview('${review.id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm font-semibold">
                                        ❌ Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-gray-600">No pending reviews. All caught up! 🎉</p></div>';
            }

            // Show recent approved reviews
            if (stats.approvedReviews.length > 0) {
                html += '<h4 class="font-semibold text-green-600 text-lg mt-6">✅ Recent Approved Reviews:</h4>';
                stats.approvedReviews.slice(-5).reverse().forEach(review => {
                    html += `
                        <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-semibold">${review.fullName}</p>
                                    <p class="text-sm text-gray-600 mb-2">${review.relationship}</p>
                                    <p class="text-sm bg-white p-2 rounded border-l-2 border-green-400">"${review.review.substring(0, 100)}${review.review.length > 100 ? '...' : ''}"</p>
                                    <p class="text-xs text-gray-500 mt-2">
                                        📅 Submitted: ${new Date(review.timestamp).toLocaleDateString()} | 
                                        ✅ Approved: ${new Date(review.approvedAt || review.timestamp).toLocaleDateString()}
                                    </p>
                                </div>
                                <div class="ml-4">
                                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">LIVE</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            html += '</div>';
            reviewsList.innerHTML = html;
        }

        function exportReviews() {
            if (window.ReviewManager) {
                window.ReviewManager.exportReviews();
            } else {
                alert('Review management system not available');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin approve page loaded');
            
            // Check if this is an approval/rejection action
            const action = getUrlParameter('action');
            const reviewId = getUrlParameter('id');

            if (action && reviewId) {
                console.log('Processing approval action:', action, reviewId);
                processReviewAction();
            } else {
                // No action specified, show admin dashboard
                console.log('No action specified, showing admin dashboard');
                document.getElementById('loadingState').classList.add('hidden');
                showAdminDashboard();
            }
        });

        // Global functions for admin actions
        window.adminApproveReview = function(reviewId) {
            if (window.ReviewManager && window.ReviewManager.approveReview(reviewId)) {
                updateAdminDashboard();
                alert('✅ Review approved successfully!');
            } else {
                alert('❌ Failed to approve review');
            }
        };

        window.adminRejectReview = function(reviewId) {
            if (confirm('Are you sure you want to reject this review? This action cannot be undone.')) {
                if (window.ReviewManager && window.ReviewManager.rejectReview(reviewId)) {
                    updateAdminDashboard();
                    alert('❌ Review rejected successfully!');
                } else {
                    alert('❌ Failed to reject review');
                }
            }
        };

        // Debug information
        window.debugReviewSystem = function() {
            console.log('=== Review System Debug Info ===');
            console.log('ReviewManager available:', !!window.ReviewManager);
            console.log('URL parameters:', {
                action: getUrlParameter('action'),
                id: getUrlParameter('id'),
                token: getUrlParameter('token')
            });
            if (window.ReviewManager) {
                console.log('Review stats:', window.ReviewManager.getStats());
            }
            console.log('=== End Debug Info ===');
        };

        // Log debug info on load
        setTimeout(() => {
            window.debugReviewSystem();
        }, 2000);
    </script>
</body>
</html>